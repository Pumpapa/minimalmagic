{{ $structure := .Site.Data.structure }}
{{ $currentBook := "" }}
{{ $currentPart := "" }}
{{ if and .Params .Params.categories }}
  {{ $currentBook = index .Params.categories 0 | default "" }}
  {{ if gt (len .Params.categories) 1 }}
    {{ $currentPart = index .Params.categories 1 }}
  {{ end }}
{{ end }}
{{ $pageType := "main" }}
{{ if .IsHome }}
  {{ $pageType = "main" }}
{{ else if eq (lower .Section) (lower $currentBook) }}
  {{ if $currentPart }}
    {{ $pageType = "part" }}
  {{ else }}
    {{ $pageType = "book" }}
  {{ end }}
{{ else if .IsPage }}
  {{ $pageType = "chapter" }}
{{ end }}

<div class="toc">
  <ul class="toc-ul">
	  {{ $books := slice }}
	  {{ range $key, $value := $structure.books }}
		{{ $books = $books | append (merge $value (dict "key" $key)) }}
	  {{ end }}
	  {{ range $bookKey, $book := sort $books "weight" }}
		{{ $bookKey := $book.key }}
      {{ $isCurrentBook := eq (lower $bookKey) (lower $currentBook) }}
      {{ $isOpen := or (and (eq $pageType "book") $isCurrentBook) (and (eq $pageType "part") $isCurrentBook) (and (eq $pageType "chapter") $isCurrentBook) }}
      <li class="toc-li">
        <details {{ if $isOpen }}open{{ end }}>
          <summary class="tocX">{{ $bookKey | title }}</summary>
          <ul class="toc-ul">
            {{ range $partKey, $partData := $book.parts }}
              {{ $partDisplay := $partData.title | default (replace $partKey "-" " " | title) }}
              {{ $isCurrentPart := and $isCurrentBook (eq (lower $partKey) (lower $currentPart)) }}
              <li class="toc-li">
                <details {{ if $isCurrentPart }}open{{ end }} data-part-key="{{ $partKey }}">
                  <summary class="tocM">{{ $partDisplay }}</summary>
                  <ul class="toc-ul">
                    {{ range sort $partData.chapters "weight" }}
                      {{ $file := .file }}
                      {{ $chapterPage := false }}
                      {{ $validPages := where site.Pages "File" "ne" nil }}
                      {{ $match := where $validPages "File.Path" (printf "%s/%s/%s" $bookKey $partKey $file) }}
                      {{ if not $match }}
                        {{ $match = where $validPages "File.Path" (printf "%s/%s/%s" $bookKey $partKey (replace $file ".md" "")) }}
                      {{ end }}
                      {{ if not $match }}
                        {{ $match = where $validPages "File.UniqueID" $file }}
                      {{ end }}
                      {{ if not $match }}
                        {{ $filename := replace $file ".md" "" }}
                        {{ $match = where $validPages "File.BaseFileName" $filename }}
                      {{ end }}
                      {{ if $match }}
                        {{ $chapterPage = index $match 0 }}
                      {{ end }}
                      {{ with $chapterPage }}
                        {{ $isCurrentChapter := and $isCurrentPart (eq .File.Path $.File.Path) }}
                        <li class="toc-li">
                          <a class="toc-a {{ if $isCurrentChapter }}toc-active{{ end }}" href="{{ .RelPermalink }}">{{ .Title }}</a>
                        </li>
                      {{ end }}
                    {{ end }}
                  </ul>
                </details>
              </li>
            {{ end }}
          </ul>
        </details>
      </li>
    {{ end }}
  </ul>
</div>
